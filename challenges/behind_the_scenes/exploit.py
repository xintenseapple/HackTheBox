import pathlib

from pwn import *

import utils.target

# Specify GDB script here (breakpoints etc.)
gdb_script = '''
piebase
'''.format(**locals())

# Binary filename
parent_dir = pathlib.Path(__file__).parent
exe = parent_dir / 'behindthescenes'

# This will automatically get context arch, bits, os etc
elf = context.binary = ELF(exe, checksec=False)

# ===========================================================
#                    EXPLOIT GOES HERE
# ===========================================================

# Password 'Itz_0nLy_UD2' found by reversing the binary in Ghidra
# The binary was slightly obfuscated. It registered a signal handler to
# override a SIGKILL signal and simply continue execution at the next
# instruction. It then had UD2 instructions scattered throughout that
# triggered the SIGKILL and simply jumped to the next instruction.
# Ghidra did not disassemble the instructions following the UD2s, obfuscating
# much of the code.

io = utils.target.start(exe=str(exe),
                        gdb_script=gdb_script,
                        argv=["Itz_0nLy_UD2"])

success(io.recvline().decode("ascii"))
